clear; clc;

rawdata = readtable('./phase_2mov_8sec4.csv');

EPC = split(string(rawdata.EPC(:)));
time = str2double(rawdata.Timestamp(:));
freq = str2double(rawdata.ChannelInMhz(:));
rssi = str2double(rawdata.PeakRssiInDbm(:));
phase = str2double(rawdata.PhaseAngleInRadians(:));

time = time - time(1);

%%EPC = split(EPC);
EPC = EPC(:,6);
rawdataSIZE = size(EPC);
rawdataSIZE = rawdataSIZE(1);

centerfreq = 925.0;
humID = {'BC48'};
objID = {'BE05'};
humSIZE = size(humID);
humSIZE = humSIZE(2);
objSIZE = size(objID);
objSIZE = objSIZE(2);

phasecor = (phase ./ freq) .* centerfreq;

[rawEPC, rawphase, rawrssi, rawSIZE] = AddBlank(time, EPC, phasecor, rssi, rawdataSIZE);


[hum_phase, hum_rssi ,hum_firstT, hum_endT, hum_idx] = SubsetD(rawEPC, rawphase, rawrssi, humID, humSIZE, rawSIZE);
[obj_phase, obj_rssi ,obj_firstT, obj_endT, obj_idx] = SubsetD(rawEPC, rawphase, rawrssi, objID, objSIZE, rawSIZE);

delta_T = zeros(humSIZE, objSIZE);
delta_phase = zeros(humSIZE, objSIZE);
delta_rssi = zeros(humSIZE, objSIZE);

for i = 1:humSIZE
    for j = 1:objSIZE
        delta_T(i, j) = abs(hum_firstT(i) - obj_firstT(j)) +  abs(hum_endT(i) - obj_endT(j));
        s_first = max(hum_firstT(i), obj_firstT(j));
        s_end = min(hum_endT(i), obj_endT(j));
        if (s_first > s_end)
            delta_phase(i, j) = inf;
            delta_rssi(i, j) = inf;
        else
            for k = s_first:s_end - 1
                dif_hum = hum_phase(i, k) - hum_phase(i, k + 1);
                dif_obj = _phase(i, k) - hum_phase(i, k + 1);
                delta_rssi(i, j) = delta_rssi(i, j) + abs(hum_rssi(i, k) - obj_rssi(j, k));
            end
            for k = s_first:s_end
                delta_rssi(i, j) = delta_rssi(i, j) + abs(hum_rssi(i, k) - obj_rssi(j, k));
            end
        end
    end
end
